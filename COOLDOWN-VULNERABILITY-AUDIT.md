# 🔒 Complete Cooldown Vulnerability Audit

## 🎯 ALL Possible Escape Scenarios

### Scenario 1: Normal Rescind
```
Action: User clicks "Cancel Request" button
Current Code: server/src/index.ts line 734-737
Cooldown: ✅ 1 hour
Status: ✅ WORKING
```

### Scenario 2: Close Matchmaking While Waiting  
```
Action: User clicks X button on matchmaking overlay
Current Code: components/matchmake/MatchmakeOverlay.tsx handleClose()
Cooldown: ✅ 1 hour (just added!)
Status: ✅ FIXED
```

### Scenario 3: Browser Back Button While Waiting
```
Action: User presses browser back button
Current Code: ❌ NONE
Cooldown: ❌ NOT SET
Status: 🚨 VULNERABILITY - Need to add!
```

### Scenario 4: Close Browser Tab While Waiting
```
Action: User closes browser tab/window
Current Code: ❌ NONE (socket disconnects)
Cooldown: ❌ NOT SET  
Status: 🚨 VULNERABILITY - Need to add!
```

### Scenario 5: Navigate to Different Page While Waiting
```
Action: User types different URL, clicks link
Current Code: ❌ NONE
Cooldown: ❌ NOT SET
Status: 🚨 VULNERABILITY - Need to add!
```

### Scenario 6: Page Reload While Waiting
```
Action: User refreshes page (Cmd+R)
Current Code: Socket disconnects, invite expires
Cooldown: ❌ NOT SET
Status: 🚨 VULNERABILITY - Need to add!
```

### Scenario 7: Timeout (No Response After 20s)
```
Action: Callee doesn't respond in 20s
Current Code: components/matchmake/CalleeNotification.tsx line 36
  → Calls onDecline(inviteId)
  → server/src/index.ts line 685: Sets 24h cooldown
Cooldown: ✅ 24 hours
Status: ✅ WORKING
```

### Scenario 8: Active Decline
```
Action: Callee clicks "Decline" button
Current Code: server/src/index.ts line 685
Cooldown: ✅ 24 hours
Status: ✅ WORKING
```

### Scenario 9: Call Completes Successfully
```
Action: Full call happens, both users stay
Current Code: server/src/index.ts line 899
Cooldown: ✅ 24 hours
Status: ✅ WORKING
```

### Scenario 10: Disconnect During Active Call
```
Action: User disconnects while in video call
Current Code: server/src/index.ts line 1022
Cooldown: ✅ 24 hours
Status: ✅ WORKING
```

---

## 🚨 VULNERABILITIES FOUND (4)

### Vulnerability #1: Browser Back Button
**Impact:** User can escape waiting screen without cooldown
**Fix Needed:** beforeunload event or route guard

### Vulnerability #2: Close Tab
**Impact:** User can close tab without cooldown
**Fix Needed:** beforeunload event to send rescind

### Vulnerability #3: Navigate Away
**Impact:** User can navigate to /main, /settings, etc. without cooldown
**Fix Needed:** Route change guard

### Vulnerability #4: Page Reload
**Impact:** User can refresh page without cooldown
**Fix Needed:** beforeunload event

---

## ✅ SOLUTION: Page Unload Handler

Add to MatchmakeOverlay.tsx:

```typescript
useEffect(() => {
  // Handle page unload/navigation while waiting
  const handleBeforeUnload = (e: BeforeUnloadEvent) => {
    const waitingInvites = Object.entries(inviteStatuses)
      .filter(([_, status]) => status === 'waiting');
    
    if (waitingInvites.length > 0 && socketRef.current) {
      // Auto-rescind before page closes
      waitingInvites.forEach(([userId]) => {
        socketRef.current.emit('call:rescind', { toUserId: userId });
      });
      
      // Show confirmation dialog
      e.preventDefault();
      e.returnValue = 'You have a pending call request. Leaving will cancel it and set a 1-hour cooldown.';
      return e.returnValue;
    }
  };
  
  window.addEventListener('beforeunload', handleBeforeUnload);
  
  return () => {
    window.removeEventListener('beforeunload', handleBeforeUnload);
  };
}, [inviteStatuses]);
```

This handles:
- ✅ Close tab
- ✅ Page reload  
- ✅ Navigate away
- ✅ Browser back button
- ✅ Shows warning before leaving
- ✅ Sends rescind (sets cooldown)

