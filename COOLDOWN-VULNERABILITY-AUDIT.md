# ðŸ”’ Complete Cooldown Vulnerability Audit

## ðŸŽ¯ ALL Possible Escape Scenarios

### Scenario 1: Normal Rescind
```
Action: User clicks "Cancel Request" button
Current Code: server/src/index.ts line 734-737
Cooldown: âœ… 1 hour
Status: âœ… WORKING
```

### Scenario 2: Close Matchmaking While Waiting  
```
Action: User clicks X button on matchmaking overlay
Current Code: components/matchmake/MatchmakeOverlay.tsx handleClose()
Cooldown: âœ… 1 hour (just added!)
Status: âœ… FIXED
```

### Scenario 3: Browser Back Button While Waiting
```
Action: User presses browser back button
Current Code: âŒ NONE
Cooldown: âŒ NOT SET
Status: ðŸš¨ VULNERABILITY - Need to add!
```

### Scenario 4: Close Browser Tab While Waiting
```
Action: User closes browser tab/window
Current Code: âŒ NONE (socket disconnects)
Cooldown: âŒ NOT SET  
Status: ðŸš¨ VULNERABILITY - Need to add!
```

### Scenario 5: Navigate to Different Page While Waiting
```
Action: User types different URL, clicks link
Current Code: âŒ NONE
Cooldown: âŒ NOT SET
Status: ðŸš¨ VULNERABILITY - Need to add!
```

### Scenario 6: Page Reload While Waiting
```
Action: User refreshes page (Cmd+R)
Current Code: Socket disconnects, invite expires
Cooldown: âŒ NOT SET
Status: ðŸš¨ VULNERABILITY - Need to add!
```

### Scenario 7: Timeout (No Response After 20s)
```
Action: Callee doesn't respond in 20s
Current Code: components/matchmake/CalleeNotification.tsx line 36
  â†’ Calls onDecline(inviteId)
  â†’ server/src/index.ts line 685: Sets 24h cooldown
Cooldown: âœ… 24 hours
Status: âœ… WORKING
```

### Scenario 8: Active Decline
```
Action: Callee clicks "Decline" button
Current Code: server/src/index.ts line 685
Cooldown: âœ… 24 hours
Status: âœ… WORKING
```

### Scenario 9: Call Completes Successfully
```
Action: Full call happens, both users stay
Current Code: server/src/index.ts line 899
Cooldown: âœ… 24 hours
Status: âœ… WORKING
```

### Scenario 10: Disconnect During Active Call
```
Action: User disconnects while in video call
Current Code: server/src/index.ts line 1022
Cooldown: âœ… 24 hours
Status: âœ… WORKING
```

---

## ðŸš¨ VULNERABILITIES FOUND (4)

### Vulnerability #1: Browser Back Button
**Impact:** User can escape waiting screen without cooldown
**Fix Needed:** beforeunload event or route guard

### Vulnerability #2: Close Tab
**Impact:** User can close tab without cooldown
**Fix Needed:** beforeunload event to send rescind

### Vulnerability #3: Navigate Away
**Impact:** User can navigate to /main, /settings, etc. without cooldown
**Fix Needed:** Route change guard

### Vulnerability #4: Page Reload
**Impact:** User can refresh page without cooldown
**Fix Needed:** beforeunload event

---

## âœ… SOLUTION: Page Unload Handler

Add to MatchmakeOverlay.tsx:

```typescript
useEffect(() => {
  // Handle page unload/navigation while waiting
  const handleBeforeUnload = (e: BeforeUnloadEvent) => {
    const waitingInvites = Object.entries(inviteStatuses)
      .filter(([_, status]) => status === 'waiting');
    
    if (waitingInvites.length > 0 && socketRef.current) {
      // Auto-rescind before page closes
      waitingInvites.forEach(([userId]) => {
        socketRef.current.emit('call:rescind', { toUserId: userId });
      });
      
      // Show confirmation dialog
      e.preventDefault();
      e.returnValue = 'You have a pending call request. Leaving will cancel it and set a 1-hour cooldown.';
      return e.returnValue;
    }
  };
  
  window.addEventListener('beforeunload', handleBeforeUnload);
  
  return () => {
    window.removeEventListener('beforeunload', handleBeforeUnload);
  };
}, [inviteStatuses]);
```

This handles:
- âœ… Close tab
- âœ… Page reload  
- âœ… Navigate away
- âœ… Browser back button
- âœ… Shows warning before leaving
- âœ… Sends rescind (sets cooldown)

